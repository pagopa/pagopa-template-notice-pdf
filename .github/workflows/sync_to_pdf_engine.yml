name: Sync Files to PDF Engine

on:
  push:
    branches:
      - main
    paths:
      - "src/helpers/**"
      - "src/partials/**"
        
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-files:
    name: Create PR to pagopa-pdf-engine
    runs-on: ubuntu-latest

    steps:
      - name: Checkout template-notice-pdf
        uses: actions/checkout@1f9a0c22da41e6ebfa534300ef656657ea2c6707
        with:
          path: source

      - name: Checkout pdf-engine
        uses: actions/checkout@1f9a0c22da41e6ebfa534300ef656657ea2c6707
        with:
          repository: pagopa/pagopa-pdf-engine
          token: ${{ secrets.BOT_TOKEN_GITHUB }}
          path: target

      - name: Sync partials
        run: |
          cp source/src/partials/*.hbs target/node/pdf-generate/partials/notices/

      - name: Sync helpers
        run: |
          cp source/src/helpers/*.js target/node/pdf-generate/helpers/notices/

      - name: Check for changes
        id: check_changes
        working-directory: target
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --porcelain
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@153407881ec5c347639a548ade7d8ad1d6740e38
        with:
          token: ${{ secrets.BOT_TOKEN_GITHUB }}
          path: target
          commit-message: "chore: sync notice templates from pagopa-template-notice-pdf"
          committer: pagopa-github-bot <pagopa-github-bot@pagopa.it>
          author: pagopa-github-bot <pagopa-github-bot@pagopa.it>
          branch: chore/sync-notice-templates
          delete-branch: true
          title: "chore: sync notice templates from pagopa-template-notice-pdf"
          body: |
            ## Summary

            This PR syncs notice templates and helpers from [pagopa-template-notice-pdf](https://github.com/pagopa/pagopa-template-notice-pdf).

            ### Files synced:
            - `src/partials/*.hbs` → `node/pdf-generate/partials/notices/`
            - `src/helpers/*.js` → `node/pdf-generate/helpers/notices/`

            ---

            > [!IMPORTANT]
            > ## Deployment Reminder
            > After merging this PR, remember to **release and deploy `pagopa-pdf-engine`** to apply the template changes.
            >
            > Follow the standard release process for the pdf-engine service.

            ---

            :robot: This PR was automatically generated by the [sync workflow](https://github.com/pagopa/pagopa-template-notice-pdf/actions/workflows/sync_to_pdf_engine.yml).
          labels: |
            patch
            automatic
            templates
